-- temp table of all revision ids older than 30 days
drop temporary table if exists tmp_old_node_revs;
create temporary table tmp_old_node_revs
select vid, date_format(from_unixtime(revision_timestamp), '%e %b %Y') AS 'date', revision_timestamp
from node_revision
where revision_timestamp < unix_timestamp(date_sub(now(), interval 30 day)) 
order by revision_timestamp;

-- tables with > 1 Mb
-- | node_revision__field_body_content               |     64.27 |
-- | node_revision__field_summary                    |      6.55 |
-- | node_revision__field_topics                     |      6.06 |
-- | node_revision__field_display_groups             |      3.94 |
-- | node_revision__field_service_mode               |      3.31 |
-- | node_revision__field_audience                   |      2.80 |
-- | node_revision__field_related_content            |      1.39 |
-- | node_revision__field_popular                    |      1.31 |
-- | node_revision__field_page_type                  |      1.23 |

-- delete all revision data from a specific table older than 30 days
-- by joining to the temp table. unfortunately this needs to be run
-- for every applicable table, with no good way to automate it.
delete C
from node_revision__field_body_content as C
inner join tmp_old_node_revs REV on C.revision_id = REV.vid
where revision_timestamp < unix_timestamp(date_sub(now(), interval 30 day)) and delta > 0;

delete C
from node_revision__field_summary as C
inner join tmp_old_node_revs REV on C.revision_id = REV.vid
where revision_timestamp < unix_timestamp(date_sub(now(), interval 30 day)) and delta > 0;

delete C
from node_revision__field_topics as C
inner join tmp_old_node_revs REV on C.revision_id = REV.vid
where revision_timestamp < unix_timestamp(date_sub(now(), interval 30 day)) and delta > 0;

delete C
from node_revision__field_display_groups as C
inner join tmp_old_node_revs REV on C.revision_id = REV.vid
where revision_timestamp < unix_timestamp(date_sub(now(), interval 30 day)) and delta > 0;

delete C
from node_revision__field_service_mode as C
inner join tmp_old_node_revs REV on C.revision_id = REV.vid
where revision_timestamp < unix_timestamp(date_sub(now(), interval 30 day)) and delta > 0;

delete C
from node_revision__field_audience as C
inner join tmp_old_node_revs REV on C.revision_id = REV.vid
where revision_timestamp < unix_timestamp(date_sub(now(), interval 30 day)) and delta > 0;

delete C
from node_revision__field_related_content as C
inner join tmp_old_node_revs REV on C.revision_id = REV.vid
where revision_timestamp < unix_timestamp(date_sub(now(), interval 30 day)) and delta > 0;

delete C
from node_revision__field_popular as C
inner join tmp_old_node_revs REV on C.revision_id = REV.vid
where revision_timestamp < unix_timestamp(date_sub(now(), interval 30 day)) and delta > 0;

delete C
from node_revision__field_page_type as C
inner join tmp_old_node_revs REV on C.revision_id = REV.vid
where revision_timestamp < unix_timestamp(date_sub(now(), interval 30 day)) and delta > 0;

drop temporary table tmp_old_node_revs;

-- now delete the revisions themselves
delete from node_revision
where revision_timestamp < unix_timestamp(date_sub(now(), interval 30 day));
